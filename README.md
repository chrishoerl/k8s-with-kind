# k8s-with-kind

## How to create local clusters with kind directly from k8s sources

### Motivation

#### The problem

In 2019 I ran a bare-metal Kubernetes cluster (v1.13.x) and suddenly everything stopped working.
Quickly I found out, the internal certificates of k8s were expired.

Since it was a bare-metal cluster originally installed with kubespray / kubeadm by my predecessor in my former company I did not know wo much about it.

My first intention was to reset the date and time on the k8s nodes to play tricks to the k8s API server and it seemed to work.

I could immediately reconnect to kube API with kubectl.
But of course etcd complained that it was not perfectly time-synced. It was - of course - clear to me that this is not a final solution.

#### The solution

After searching on the web I found this [video](https://www.youtube.com/live/Cl-EWv3LmJA?feature=share) by Duffie Cooley on Youtube. He talks about the same scenario of expired certificates in k8s and how to renew them.

I watched the whole 1.5 hours video at first and then tried to follow along each and every stepps of his on-screen guidance.
He gives a lot of valuable background information.

In the concrete situation most important information for me was to get the right kubeadm commands how to renew my certificates and how to copy
the new certificates to the right directories on my cluster nodes.

I had a problem which the guide in the video did not have. I was using k8s v1.13.x in which kubeadm command did not offer all comfortables parameters and all certificates ahd to be renewed manually. But I found it out.

Finally after a few hours I had everything in place and I was able to restart my cluster components and reconnect via kubectl again!

Perfect!!! Mission accomplished!

#### The lesson learned and even more

So you may ask: what have expired certificates to do with this guid of creating k8s node-images for the tool "kind"?

Well, first after solving a nasty cluster situaion I was pretty happy and almost forgot about the circumstances and guidance that helped me through.

In his video, Duffie explains and uses the tool kind to create a local k8s cluster.
And to reproduce a k8s cluster of which all certificates have just expired he creates a node-image directly from kubernetes sources which has a manipulated version of kubeadm. It can only issue certificates no langer valid than 15 minutes.

And I was wondering how he did this.

So I watched the first ~30 Minutes over and over again and followed along his screen recording in every details.
He explains how it is possible to create a k8s cluster with kind (which I knew before) but with customized code directly created from a "git clone'd" version of the upstream k8s sources.

I found this pretty clever because with this "trick" you can build customized clusters which give you the possibility of testing and "breaking" all functions and features of Kubernetes for let's say: training purposes or to learn things about the very architecture or Kubernetes.

So give it a try. Both, Kubernetes and kind.

### Prerequisites

- docker version 23.0.1
- go version go1.19.3
- Ubuntu 22.04 (Jammy)


#### determine your $GOPATH

```shell
go env $GOPATH

# Result:
# /home/<user>/go
```

#### Download Kubernetes sources

```shell
mkdir -p $GOPATH/src/k8s.io
cd $GOPATH/src/k8s.io
git clone https://github.com/kubernetes/kubernetes
cd kubernetes
```

#### Checkout a specific version

```shell
git checkout v1.25.3
```

#### Change the default validity of certificates issued by kubeadm

* Therefore edit this file:

```shell
vi GOPATH/src/k8s.io/kubernetes/cmd/kubeadm/app/constants.go
```

* Change this line:

```go
// CertificateValidity defines the validity for all the signed certificates generated by kubeadm
// CertificateValidity = time.Hour * 24 * 365
// change validity to 10 minutes
CertificateValidity = time.Hour / 6
```

* See the original source code

https://github.com/kubernetes/kubernetes/blob/v1.25.3/cmd/kubeadm/app/constants/constants.go#L49

#### Create a node-image for kind

```shell
# build with 1 single kind command (this will take a few minutes ~10-15min)
kind build node-image --image=myname/node:v1.25.3-shorttime
```

---

**Optional / Background info**

This is what kind does implicitely

```shell
make quick-release-images 'KUBE_EXTRA_WHAT=cmd/kubeadm cmd/kubectl cmd/kubelet' KUBE_VERBOSE=0 KUBE_BUILD_HYPERKUBE=n KUBE_BUILD_CONFORMANCE=n KUBE_BUILD_PLATFORMS=linux/amd64
```

---

#### list your final built docker image

```shell
docker image ls
```

---

***Optional***

Prepare a kind config

---


#### Create your kind cluster

```shell 
kind create cluster --config config --image=myname/node:v1.25.3-shorttime
```

#### Use kind

* when the kind cluster is up and running jump right into your control-plane node from your local docker machine

```shell
docker exec -it kind-control-plane bash
```

* inside the control-plane node check certificate validity (for example of apiserver.crt)

```shell
root@kind-control-plane:
cat /etc/kubernetes/pki/apiserver.crt | openssl  x509 -text | grep "Not "      

Not Before: Mar 26 20:11:00 2023 GMT
Not After : Mar 26 20:17:00 2023 GMT
```

* Result: you see the certificates issued by kubeadm are only valid for 6 minutes

#### Wait for expiry

* as soon as the certs are expired you get this message:

```shell
kubectl get pods
Unable to connect to the server: x509: certificate has expired or is not yet valid: current time 2023-03-26T22:16:23+02:00 is after 2023-03-26T20:17:00Z
```

* Verify expiration of all certificates with kubeadm

```shell
root@kind-control-plane:/etc/kubernetes/pki# kubeadm certs check-expiration
```

```text
[check-expiration] Reading configuration from the cluster...
[check-expiration] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'
[check-expiration] Error reading configuration from the Cluster. Falling back to default configuration

CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 Mar 26, 2023 20:17 UTC   <invalid>       ca                      no      
apiserver                  Mar 26, 2023 20:17 UTC   <invalid>       ca                      no      
apiserver-etcd-client      Mar 26, 2023 20:17 UTC   <invalid>       etcd-ca                 no      
apiserver-kubelet-client   Mar 26, 2023 20:17 UTC   <invalid>       ca                      no      
controller-manager.conf    Mar 26, 2023 20:17 UTC   <invalid>       ca                      no      
etcd-healthcheck-client    Mar 26, 2023 20:17 UTC   <invalid>       etcd-ca                 no      
etcd-peer                  Mar 26, 2023 20:17 UTC   <invalid>       etcd-ca                 no      
etcd-server                Mar 26, 2023 20:17 UTC   <invalid>       etcd-ca                 no      
front-proxy-client         Mar 26, 2023 20:17 UTC   <invalid>       front-proxy-ca          no      
scheduler.conf             Mar 26, 2023 20:17 UTC   <invalid>       ca                      no      

CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
ca                      Mar 23, 2033 20:11 UTC   9y              no      
etcd-ca                 Mar 23, 2033 20:11 UTC   9y              no      
front-proxy-ca          Mar 23, 2033 20:11 UTC   9y              no
```

#### renew the certificate by

* still within control-plane node issue:

```shell
kubeadm certs renew all
```

* Result: you get this message

```text
Done renewing certificates. You must restart the kube-apiserver, kube-controller-manager, kube-scheduler and etcd, so that they can use the new certificates.
```

* Restart containers (still on kind control-plane)

```shell
cd /etc/kubernetes/manifests
mv *.yaml ../

# wait 1 minute

mv ../*.yaml .

# wait 1 minute
```

* Verify kube-apiserver, kube-controller-manager, kube-scheduler and etcd ware running

```shell
crictl ps
```

---

## Reference / Credits

* Talk by Duffie Cooley - "TGI Kubernetes 077: All your certificates have expired"

https://www.youtube.com/live/Cl-EWv3LmJA?feature=share

* Install kind

https://github.com/kubernetes-sigs/kind/releases/tag/v0.17.0

* Kubernetes

https://github.com/kubernetes/kubernetes/tree/v1.25.3#to-start-developing-k8s

* How to install and use Docker on Ubuntu 22.04 (Ditigal Ocean)

https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-22-04
